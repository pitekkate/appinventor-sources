name: 'App Inventor CI - Build with R8'

on:
  push:
    branches: [ r8 ]  # Ganti sesuai branch kamu
  pull_request:
    branches: [ r8 ]

jobs:
  build:
    name: 'Build App Inventor with R8'
    runs-on: ubuntu-latest

    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v4

      - name: 'Set up JDK 11'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 11
          # Tidak pakai cache: ant â†’ tidak didukung di v4

      - name: 'Checkout submodules recursively'
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive

      - name: 'Clean workspace'
        run: |
          rm -rf appinventor/build/
          mkdir -p appinventor/build/logs
          mkdir -p appinventor/buildserver/tmp

      - name: 'Install 32-bit dependencies for native tools'
        run: |
          sudo apt-get update
          sudo apt-get install -y libc6-i386 lib32z1 lib32stdc++6

      - name: 'Download and setup PhantomJS'
        run: |
          mkdir -p /tmp/phantomjs
          wget -q -O /tmp/phantomjs/phantomjs-2.1.1-linux-x86_64.tar.bz2 \
            https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-linux-x86_64.tar.bz2 
          tar -xjf /tmp/phantomjs/phantomjs-2.1.1-linux-x86_64.tar.bz2 -C /tmp/phantomjs/
          echo '/tmp/phantomjs/phantomjs-2.1.1-linux-x86_64/bin' >> $GITHUB_PATH

      - name: 'Verify Java & Ant setup'
        run: |
          echo "JAVA_HOME = $JAVA_HOME"
          java -version
          javac -version
          ant -version

      - name: 'Configure build environment'
        working-directory: appinventor
        run: |
          # Pastikan Ant tahu lokasi JDK
          echo "java.home=${JAVA_HOME}" > local.build.properties
          echo "build.compiler=javac1.8" >> local.build.properties
          echo "ant.build.javac.source=8" >> local.build.properties
          echo "ant.build.javac.target=8" >> local.build.properties

      - name: 'Generate Auth Key'
        working-directory: appinventor
        run: ant MakeAuthKey

      - name: 'Build MIT AI2 Companion (with R8)'
        working-directory: appinventor
        run: ant PlayApp

      - name: 'Check output: classes.dex existence'
        if: failure()
        run: |
          echo "=== Checking tmp dir ==="
          find . -path "*/tmp/*.dex" -ls 2>/dev/null || echo "No .dex files found"
          echo "=== Contents of buildserver/dexCache ==="
          ls -la appinventor/build/buildserver/dexCache/ 2>/dev/null || echo "dexCache empty or not created"

      - name: 'Upload Companion APK'
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: MIT-AI2-Companion-APK
          path: appinventor/build/buildserver/MIT\ AI2\ Companion.apk
          if-no-files-found: warn

      - name: 'Debug: Show final logs on failure'
        if: failure()
        run: |
          echo "=== Last 100 lines of build log ==="
          tail -100 appinventor/build/logs/build.log || echo "No log file"
